# 可逆送金型ブロックチェーン仕様書

**バージョン 0.1 - ドラフト**

## 1. 概要

この仕様書は、誤送金や詐欺による損失を、組み込みのトランザクション可逆性によって防止するために設計された新しいレイヤー1ブロックチェーンについて記述します。

### 1.1 設計思想

核心原則：**トランザクションは即座に確定せず、送信者と受取人の両方が確認するまで保留状態を維持する**

これにより以下が可能になります：
- 誤送金からの回復
- レビュー期間による詐欺防止
- 安全なマルチパーティトランザクション

### 1.2 実装言語

- **メイン**: Julia
- **理由**: 高性能な数値計算、手数料アルゴリズムの実験が容易、強力な並列処理サポート

---

## 2. アーキテクチャ

### 2.1 3層構造

```
┌─────────────────────────────────────────────────────────────┐
│  レイヤー2（将来）                                           │
│  - バッチ処理、スケーリングソリューション                    │
├─────────────────────────────────────────────────────────────┤
│  アプリケーション層                                          │
│  - ウォレットUI、DApps、サービス                             │
│  - 安全性チェック、証拠管理                                  │
├─────────────────────────────────────────────────────────────┤
│  レイヤー1（ブロックチェーンコア）                           │
│  - 台帳、状態管理                                            │
│  - 保留/確定トランザクション状態                             │
│  - Julia実装                                                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. トランザクションフロー

### 3.1 基本フロー

```
1. 送金
   ユーザーがウォレットから送金操作を開始。
   受取人のウォレットが受入ルール（即時/保留）を返す。
   保留の場合：トランザクションが「保留中」として記録、送信者から資金が引き落とし。

2. 確認
   受取人が「受領確認」ボタンを押す。
   ブロックチェーンが確認を記録、トランザクション確定。
   タイムアウト：設定に基づき自動確定または自動返金。

3. 取消
   受取人が確認する前に送信者がキャンセル可能。
   悪用防止のための小額のキャンセル手数料が必要。

4. 不正対応
   不審なトランザクションはフラグを立てて凍結可能。
   ガーディアン（信頼されたマルチシグ）がレビューし、回復を決定。
```

### 3.2 状態遷移図

```
                    ┌─────────────┐
                    │    作成     │
                    └──────┬──────┘
                           │
                           ▼
┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│   取消済み   │◄───│   保留中    │───►│    凍結中    │
└──────────────┘    └──────┬──────┘    └──────┬───────┘
       ▲                   │                  │
       │                   ▼                  ▼
       │            ┌─────────────┐    ┌──────────────┐
       └────────────│    確定     │    │   回復済み   │
                    └─────────────┘    └──────────────┘
```

---

## 4. トランザクション状態

| 状態 | 説明 |
|:--|:--|
| **保留中（Pending）** | 送金は行われたが、まだ受取人が確定していない状態 |
| **確定（Finalized）** | 受取人が受領を確定、またはタイムアウトで自動確定した状態 |
| **取消済み（Cancelled）** | 確定前に送信者がキャンセルを要求した状態 |
| **凍結中（Frozen）** | 詐欺の疑いでフラグが立ち、ガーディアンレビュー中の状態 |
| **回復済み（Recovered）** | ガーディアン承認後、送信者に資金が返還された状態 |

---

## 5. 安全性メカニズム

### 5.1 意図バインディング

- 送金には宛先、金額、メモ（目的）を含む
- すべて一緒に署名
- 不一致があるとトランザクション無効

### 5.2 ハンドシェイクプロトコル

受取人のウォレットが自動的に「受領確認メッセージ」を返す。
応答がない場合：自動的に保留扱い。

### 5.3 取消制限

- 取消には小額の手数料が必要（悪用防止）
- 取消回数と総額に制限
- 同時取消のレート制限

### 5.4 詐欺対策

- 複数の報告で自動凍結をトリガー
- 資金回復のためのガーディアンマルチシグ
- 証拠はオフチェーン保存、オンチェーンはハッシュのみ

---

## 6. ワンタイム鍵（合言葉）システム

### 6.1 目的

送信者と受取人の両方が同じ合言葉を持っていることを確認してから送金を完了させ、誤送金となりすましを減らす。

### 6.2 メカニズム

1. 送信者ウォレットが固有の合言葉を生成（ランダム文字列/QR）
2. 合言葉を受取人に配信（アプリメッセージ/QR/リンク）
3. 受取人が同じ合言葉を使って確認を返す
4. 台帳は合言葉のハッシュのみを保存
5. 一致する確認ハッシュで保留→確定に進む

### 6.3 2つのモード

**シンプルハンドシェイク**
- 送信者が合言葉を作成
- 受取人が合言葉をそのまま返す
- 一致で送金確定
- 長所：実装がシンプル
- 短所：傍受されると脆弱

**強いハンドシェイク**
- 送信者が合言葉を作成
- 受取人が自分の秘密を混ぜた応答を返す
- 台帳は秘密を明かさずに対応を検証
- 長所：傍受に強い

### 6.4 トランザクションレコードフィールド

```julia
struct Transaction
    # ... 既存フィールド ...
    handshake_id::String      # 合言葉のハッシュ
    ack_id::String            # 受取人応答のハッシュ
    state::TransactionState   # 保留中(合言葉待ち) → 一致 → 確定/取消
end
```

### 6.5 レガシーウォレットのフォールバック

受取人ウォレットがハンドシェイク非対応の場合：
- 従来の 保留 → 確認ボタン → 確定 にフォールバック

---

## 7. ガーディアンシステム

### 7.1 役割

ガーディアンは、紛争のあるトランザクションをレビューし決定する信頼されたエンティティ。

### 7.2 要件

- 最低ステーク量が必要
- 地理的/組織的多様性
- 公開監査ログ

### 7.3 決定プロセス

- k-of-m マルチシグが必要
- 応答時間のSLA
- タイムアウト時のエスカレーション

### 7.4 スラッシング条件

- 誤った判定
- 共謀の検出
- 閾値を超える非活動

---

## 8. パラメータ

### 8.1 タイミング

| パラメータ | デフォルト | 範囲 |
|:--|:--|:--|
| MIN_GRACE_PERIOD | 3分 | - |
| MAX_GRACE_PERIOD | 24時間 | - |
| DEFAULT_GRACE_PERIOD | 1時間 | - |
| HANDSHAKE_EXPIRY | 5分 | - |

### 8.2 手数料

| 操作 | 手数料構造 |
|:--|:--|
| 標準送金 | 基本手数料 + 金額の% |
| 取消 | 固定手数料 + 金額の% |
| ガーディアンレビュー | 凍結金額から拠出 |

### 8.3 制限

| パラメータ | デフォルト |
|:--|:--|
| MAX_CANCELLATIONS_PER_HOUR | 10 |
| MAX_CANCELLATION_AMOUNT_DAILY | 未定 |

---

## 9. データ構造

### 9.1 トランザクション

```julia
@enum TransactionState begin
    PENDING
    FINALIZED
    CANCELLED
    FROZEN
    RECOVERED
end

struct Transaction
    id::UUID
    sender::PublicKey
    recipient::PublicKey
    amount::BigInt
    memo::String
    created_at::DateTime
    expires_at::DateTime
    state::TransactionState
    version::Int  # 楽観的ロック用
    handshake_id::Union{Nothing, String}
    ack_id::Union{Nothing, String}
end
```

### 9.2 ブロック

```julia
struct Block
    index::Int
    timestamp::DateTime
    transactions::Vector{Transaction}
    previous_hash::String
    hash::String
    nonce::Int
end
```

---

## 10. リスク緩和策

### 10.1 MVP必須要件（★印は必須）

| リスク | 緩和策 |
|:--|:--|
| 競合状態 | ★ バージョンロックによるアトミック状態遷移 |
| 合言葉傍受 | ★ 強いハンドシェイクモード、短い有効期限、ナンス |
| 取消スパム | ★ 手数料 + レート制限 + アカウントスコアリング |
| 放置資金 | ★ タイムアウト時の自動処理 |
| 弱い乱数 | ★ 全乱数生成にOS CSPRNGを使用 |
| 時刻ずれ | ★ ブロック相対タイムスタンプ |
| エンコード曖昧性 | ★ 厳密な決定的エンコード（CBOR/MessagePack） |
| ストレージ肥大 | ★ 期限切れ保留レコードの自動クリーンアップ |

### 10.2 将来の検討事項

- クロスチェーンブリッジポリシー
- フロントランニング保護
- レイヤー2スケーリング

---

## 11. 開発優先順位（MVP）

1. シングルノード基本台帳（保留→確定→取消が動作）
2. シンプルなWebウォレット（送金/受領ボタンのみ）
3. 最小限の凍結/回復フロー（手動承認）
4. テストとUX改善
5. マルチノード同期とテスト

---

## 12. 独自性まとめ

- **保留ベースの送金**: プロトコルレベルでの誤送金損失防止
- **受取人の同意**: レイヤー1台帳に組み込み
- **Julia実装**: 研究と実験に適している
- **人間中心の設計**: 2ボタン操作
- **将来対応**: AI・法制度との統合を考慮

---

*この仕様書はワーキングドラフトであり、変更される可能性があります。*
